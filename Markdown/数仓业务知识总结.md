## 用户行为数仓

### 数仓分层

#### ODS

* origin data storage
* 原始数据层，直接加载原始日志、数据，保持数据原貌不变

#### DWD

* data warehouse detail
* 数仓明细层，结构和粒度与ODS层一致，去除了空值和格式不规范或超限的数据

#### DWS

* data warehouse service
* 数仓服务层，以dwd层为基础对数据进行轻度汇总，把数据聚集到用户、设备、商家、商品当日的粒度，通常以某个维度组成跨主题的宽表，主要是为下一层ADS层的需要服务

#### ADS

* application data storage
* 应用数据层，最终具体实现了某一项业务指标的分析



### 自定义函数

#### UDF

* 编写UDF一进一出函数完成公共字段解析

#### UDTF

* 编写UDTF一进多出函数完成事件字段的解析

### 数据库表与字段

#### ODS层

##### 1.启动表ods_start_log

> **line**
> 启动日志原始数据汇总每行json字符串

> **dt**
> 启动表按日期分组

##### 2.事件表ods_event_log

> **line**
> 事件日志原始数据汇总每行json字符串

> **dt**
> 事件表按日期分组

#### DWD层

<!-- TODO 添加表和字段信息 -->

##### 1.启动表

* 通过get_json_object函数获取ods中每个json字符串中多种字段值

2.事件表

* 通过get_json_object函数获取ods中每个json字符串中多种字段值
* 通过base_even表再次解析event_json得到多种事件的事件表

#### DWS层

##### 1.用户活跃



##### 2.用户新增



##### 3.用户留存



<!-- TODO 添加DWS层表和字段解析 -->

#### ADS层

* 见指标分析

### 指标分析

#### 1.用户活跃

* 通过启动日志，统计不同设备id的出现次数

#### 2.用户新增

* 通过用户活跃表按照设备id左连接用户新增表，并去除新增表中为null的行

#### 3.用户留存

* 前一天新增join当天活跃即为一天留存
* 当天留存/前一天新增 即为当天的留存率

#### 4.沉默用户

* 通过mid_id对日活表分组后统计出活动次数为1且活动日期最大值为一周前

#### 5.本周回流

* 本周活跃left join本周新增left join上周活跃，且本周新增和上周活跃中为null
* 本周回流=本周活跃-本周新增-上周活跃

#### 6.流失用户

* 按照mid_id进行分组，并筛选出最后登录时间(登陆时间字段的最大值字典排序最大值)为一周之前的用户

#### 7.最近连续三周活跃

* 在周活表按照mid_id分组，统计在连续三周的周活中出现次数为3的用户

#### 8.最近七天连续活跃三天

* 按照mid_id分区dt排序后开窗，并rank得出序号
* 日期和rank号差值dt_diff相同的为连续活跃的
* 按照mid_id、差值dt_diff分组并count出相同mid_idi相同差值dt_diff大于3的用户
* 对以上结果再次通过mid_id分组，去除一周内两次连续三天的用户(123,56日)的用户

## 系统业务数仓

### 指标分析

#### GMV

* 一段时间内的网站成交金额(未付款，已付款)
* 用户行为宽表，对订单金额sum求和

#### 用户新鲜度(用户转化率)

* 当日新增占日活的比例
* 使用日活表和新增表中查出日活数和新增数后union all(没有的字段用0补充)
* 分别对新增数和日活数sum求和，然后求出比率

#### 用户行为漏斗分析

* 访问->下单 转化率
* 下单->付款 转化率



#### 商品复购率

 * 

